<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>NSimon | Student Dashboard</title>
    <!-- Bootstrap & CSS -->
    <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" rel="stylesheet" />
    <script crossorigin="anonymous" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>

    <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet">

    <!-- FavIcon -->
    <link href="{{ url_for('static', filename='favicon/apple-touch-icon.png') }}" rel="apple-touch-icon"
        sizes="180x180" />
    <link href="{{ url_for('static', filename='favicon/favicon-32x32.png') }}" rel="icon" sizes="32x32"
        type="image/png" />
    <link href="{{ url_for('static', filename='favicon/favicon-16x16.png') }}" rel="icon" sizes="16x16"
        type="image/png" />
    <link href="{{ url_for('static', filename='favicon/site.webmanifest') }}" rel="manifest" />
    <link color="#5bbad5" href="{{ url_for('static', filename='favicon/safari-pinned-tab.svg') }}" rel="mask-icon" />
    <meta content="#da532c" name="msapplication-TileColor" />
    <meta content="#3a3a3a" name="theme-color" />
    <script>
        fetch('/api/getSessionSetting', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.text())
            .then(sessionSetting => {
                localStorage.setItem('sessionSetting', sessionSetting);
            })
            .catch(error => {
                console.error('Error:', error);
            });
    </script>

</head>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');
    @import url("https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css");
</style>

<body id="MainBody">

    <div aria-hidden="true" aria-labelledby="exampleModalLabel" class="modal fade" id="firstTimeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">For students using laptops:</h5>
                    <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
                </div>
                <div class="modal-body">
                    For the best experience it is <b>highly recommended to set your zoom for this web page to
                        75%-85%.</b> This will give you the best viewing experience and will remove the need to scroll.
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var myModal = new bootstrap.Modal(document.getElementById('firstTimeModal'), {});

            if (!localStorage.getItem("shownSizeModal")) {
                myModal.show();
                localStorage.setItem("shownSizeModal", "true");
            }

        });
    </script>

    {% include "partials/navbar.html" %}


    <div class="mainBody container-fluid h-100">
        <div class="row h-100 pt-3">
            <div class="col-md-3 col-12p-3 order-2 order-md-1">

                <!-- Weather -->
                <div class="big-box rounded p-3 mb-2">
                    <h4 class="pageSubtitle" style="font-weight: 600;">Weather <span style="font-size:medium;"
                            id="weatherCampus" class="pageSubtitleSub">Berwick</span>
                    </h4>
                    <div class="small-box rounded p-3 mb-2">
                        <img id="weatherIcon" src="https://openweathermap.org/img/wn/01d.png" alt="Weather Icon"
                            width="35px" height="35px">
                        <span class="class-name" id="currentWeather">Loading¬∞</span>
                        <span class="time" id="minMax">‚¨áÔ∏è Loading¬∞ | ‚¨ÜÔ∏è Loading¬∞ | ü§î Loading¬∞</span>
                        <div class="teacher-name" id="weatherInformation">Loading...</div>
                    </div>
                </div>

                <!-- Class Resources -->
                <div class="big-box rounded p-3 mb-2">
                    <h4 class="pageSubtitle" style="font-weight: 600;">Class Resources
                    </h4>

                    <!-- Due -->
                    <div class="small-box rounded p-3 mb-2" id="dueTasksBox" style="position: relative;">
                        <span class="color-dot bg-primary me-2"></span>
                        <span class="class-name" id="dueTasks">0 Due</span>
                        <i class="arrow bi bi-arrow-down-circle" style="position: absolute; right: 10px;"></i>
                        <div style="display: none" id="dueTasksExpand">
                        </div>
                    </div>
                    <script>
                        $(document).ready(function () {
                            $('#dueTasksBox').on('click', function () {
                                var dueTasksExpand = $('#dueTasksExpand');
                                var arrow = $(this).find('.arrow');

                                if (dueTasksExpand.css('display') === 'none') {
                                    dueTasksExpand.css('display', 'block');

                                    arrow.removeClass('bi-arrow-down-circle');
                                    arrow.addClass('bi-arrow-up-circle');

                                    setTimeout(() => {
                                        dueTasksExpand.addClass('visible');
                                    }, 1); // small delay to allow for display:block to take effect
                                } else {
                                    dueTasksExpand.removeClass('visible');
                                    arrow.removeClass('bi-arrow-up-circle');
                                    arrow.addClass('bi-arrow-down-circle');
                                    setTimeout(() => {
                                        dueTasksExpand.css('display', 'none');
                                    }, 300); // delay to allow for the fade out transition to complete
                                }
                            });
                        });


                    </script>

                    <!-- Overdue -->
                    <div class="small-box rounded p-3 mb-2" id="overdueTasksBox" style="position: relative;">
                        <span class="color-dot bg-danger me-2"></span>
                        <span class="class-name" id="overdueTasks">0 Overdue</span>
                        <i class="arrow bi bi-arrow-down-circle" style="position: absolute; right: 10px;"></i>
                        <div style="display: none" id="overdueTasksExpand">
                        </div>
                    </div>
                    <script>
                        $(document).ready(function () {
                            $('#overdueTasksBox').on('click', function () {
                                var dueTasksExpand = $('#overdueTasksExpand');
                                var arrow = $(this).find('.arrow');

                                if (dueTasksExpand.css('display') === 'none') {
                                    dueTasksExpand.css('display', 'block');

                                    arrow.removeClass('bi-arrow-down-circle');
                                    arrow.addClass('bi-arrow-up-circle');

                                    setTimeout(() => {
                                        dueTasksExpand.addClass('visible');
                                    }, 1); // small delay to allow for display:block to take effect
                                } else {
                                    dueTasksExpand.removeClass('visible');
                                    arrow.removeClass('bi-arrow-up-circle');
                                    arrow.addClass('bi-arrow-down-circle');
                                    setTimeout(() => {
                                        dueTasksExpand.css('display', 'none');
                                    }, 300); // delay to allow for the fade out transition to complete
                                }
                            });
                        });


                    </script>

                    <!-- Results -->
                    <div class="small-box rounded p-3 mb-2" id="resultTasksBox" style="position: relative;">
                        <span class="color-dot bg-success me-2"></span>
                        <span class="class-name" id="resultTasks">0 Results</span>
                        <i class="arrow bi bi-arrow-down-circle" style="position: absolute; right: 10px;"></i>
                        <div style="display: none" id="resultTasksExpand">
                        </div>
                    </div>
                    <script>
                        $(document).ready(function () {
                            $('#resultTasksBox').on('click', function () {
                                var dueTasksExpand = $('#resultTasksExpand');
                                var arrow = $(this).find('.arrow');

                                if (dueTasksExpand.css('display') === 'none') {
                                    dueTasksExpand.css('display', 'block');

                                    arrow.removeClass('bi-arrow-down-circle');
                                    arrow.addClass('bi-arrow-up-circle');

                                    setTimeout(() => {
                                        dueTasksExpand.addClass('visible');
                                    }, 1); // small delay to allow for display:block to take effect
                                } else {
                                    dueTasksExpand.removeClass('visible');
                                    arrow.removeClass('bi-arrow-up-circle');
                                    arrow.addClass('bi-arrow-down-circle');
                                    setTimeout(() => {
                                        dueTasksExpand.css('display', 'none');
                                    }, 300); // delay to allow for the fade out transition to complete
                                }
                            });
                        });


                    </script>

                </div>

                <!-- Today -->
                <div class="big-box rounded p-3 mb-2">
                    <h4 class="pageSubtitle" style="font-weight: 600;">Today <span style="font-size:medium;"
                            id="todayDate" class="pageSubtitleSub">LOADING</span>
                    </h4>
                    <div id="todayActivities">
                    </div>
                </div>

                <!-- Other Links -->
                <div class="big-box rounded p-3 mb-2">
                    <h4 class="pageSubtitle" style="font-weight: 600;">Other Links</h4>
                    <div class="small-box rounded p-3 mb-2">
                        <a href="/calendar" style="text-decoration: none"><span class="class-name">Calendar <i
                                    class="bi bi-box-arrow-up-right pageSubtitleSub"></i></span></a>
                    </div>
                    <div class="small-box rounded p-3 mb-2">
                        <a href="/profile" style="text-decoration: none"><span class="class-name">Profile <i
                                    class="bi bi-box-arrow-up-right pageSubtitleSub"></i></span></a>
                    </div>
                    <div class="small-box rounded p-3 mb-2">
                        <a href="/classes" style="text-decoration: none"><span class="class-name">Classes <i
                                    class="bi bi-box-arrow-up-right pageSubtitleSub"></i></span></a>
                    </div>
                </div>

            </div>

            <!-- Daily Messages -->
            <div class="col-md-6 col-12p-3 order-3 order-md-2">
                <div class="big-box rounded p-3 mb-2">
                    <h4 class="pageSubtitle" style="font-weight: 600;">Daily Messages <span style="font-size:medium;"
                            id="totalDailyMessages" class="pageSubtitleSub">LOADING...</span>
                    </h4>
                    <div class="messages-container rounded p-3" id="dailyMessages" style="overflow-y:scroll;">


                        <div class="small-box rounded p-3 mb-2" id="dailyMessagesLoading">
                            <span class="color-dot bg-danger me-2"></span>
                            <span class="class-name">Loading</span>
                            <div class="teacher-name">Your daily messages are loading...</div>
                        </div>

                    </div>
                </div>

            </div>

            <!-- Timetable -->
            <div class="col-md-3 col-12p-3 order-1 order-md-3">



                <div class="big-box rounded p-3 mb-2">

                    <h4 class="pageSubtitle" style="font-weight: 600;">Timetable
                        <button id="prevDay" class="btn btn-sm pageSubtitleSub"><i
                                class="bi bi-arrow-left"></i></button>
                        <span style="font-size:medium;" id="timetableDay" class="pageSubtitleSub">
                            LOADING...
                        </span>
                        <button id="nextDay" class="btn btn-sm pageSubtitleSub"><i
                                class="bi bi-arrow-right"></i></button>
                    </h4>

                    <div id="timetable">

                        <div class="small-box rounded p-3 mb-2" id="timetableLoading">
                            <span class="color-dot bg-primary me-2"></span>
                            <span class="class-name">Loading</span>
                            <div class="teacher-name">Your classes are loading...</div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

    </div>



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>



    <!-- Variables -->

    <!-- Get Cookie/Campus -->
    <script>
        function getCookie(cookieName) {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(cookieName + '=')) {
                    return cookie.substring(cookieName.length + 1);
                }
            }
            return null;
        }

        const authCookie = getCookie('adAuthCookie');
        const campus = getCookie('campus');

        if (authCookie == null) {
            window.location.href = '/logout';
        }

        if (campus == null) {
            window.location.href = '/logout';
        }

    </script>

    <script>
        const daysOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"]; // Days of the Week
        let currentDate = new Date(); // Current Date
        let currentISOString = currentDate.toISOString();
        let unixTimestamp = currentDate.getTime(); // Current UNIX Timestamp
        let unixTimestampInSeconds = Math.floor(unixTimestamp / 1000); // Current UNIX Timestamp in Seconds
        var totalDailyMessages = 0
    </script>


    <!-- Time/Data Updated -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            function updateDateAndTime() {
                const today = new Date();

                // Update Date
                const day = String(today.getDate()).padStart(2, '0');
                const month = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-based
                const year = today.getFullYear();
                const formattedDate = `${day}/${month}/${year}`;
                document.getElementById("currentDate").textContent = formattedDate;
                document.getElementById("todayDate").textContent = formattedDate;

                // Update Time
                let hours = today.getHours();
                const minutes = String(today.getMinutes()).padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';

                // Convert 24-hour time to 12-hour time format
                hours = hours % 12;
                // If hour is 0 (which would be 12 in 24-hour time), set it to 12
                hours = hours ? hours : 12;
                const formattedTime = `${String(hours).padStart(2, '0')}:${minutes} ${ampm}`;
                document.getElementById("currentTime").textContent = formattedTime;
            }

            // Call the function to initialize the display
            updateDateAndTime();

            // Set an interval to update the time every minute
            setInterval(updateDateAndTime, 60 * 1000); // 60 * 1000ms = 1 minute
        });
    </script>


    <!-- Functions -->
    <script>

        function removeColorStyles(htmlString) {
            // Create a new DOM parser
            let parser = new DOMParser();
            let doc = parser.parseFromString(htmlString, 'text/html');

            // Get all elements with style attributes
            let styledElements = doc.querySelectorAll('[style]');

            // Iterate through each element and remove color and background styles
            styledElements.forEach(elem => {
                let styles = elem.getAttribute('style').split(';').filter(style => {
                    return !style.trim().startsWith('color:') &&
                        !style.trim().startsWith('background-color:') &&
                        !style.trim().startsWith('background:');
                });
                elem.setAttribute('style', styles.join(';'));
            });

            // Convert the modified DOM back to an HTML string
            return doc.body.innerHTML;

        }

        function getNextMonday(currentISODate) {
            const currentDate = new Date(currentISODate);
            const dayOfWeek = currentDate.getDay();
            const daysUntilMonday = (8 - dayOfWeek) % 7; // Calculate how many days until Monday
            const nextMonday = new Date(currentDate);
            nextMonday.setDate(currentDate.getDate() + daysUntilMonday);
            return nextMonday.toISOString();
        }


        function convertToAMPM(timeString) {
            // Split the input time string into hours and minutes
            const [hours, minutes] = timeString.split(':');

            // Convert hours to a number
            const hour = parseInt(hours, 10);

            // Determine whether it's AM or PM based on the hour
            const period = hour >= 12 ? 'PM' : 'AM';

            // Convert hours to 12-hour format
            const formattedHour = hour % 12 === 0 ? 12 : hour % 12;

            // Create the formatted time string
            const formattedTime = `${formattedHour}:${minutes}${period}`;

            return formattedTime;
        }

        function filterTimetable(str) {
            const patterns = ["_", "BEA", "BER", "OFF"];
            let result = str;

            for (let pattern of patterns) {
                const regex = new RegExp(pattern, 'g');
                result = result.replace(regex, '');
            }

            return result;
        }

        function extractNumberFromString(text) {
            // Use a regular expression to match the number inside the text
            const regex = /(\d+)/;

            // Use the match method to find the first occurrence of the number
            const match = text.match(regex);

            // Check if a match was found
            if (match) {
                // Convert the matched string to a number
                const number = parseInt(match[0]);

                return number;
            }

            // If no match was found, return null or an appropriate value
            return null;
        }

        function countTotalTasks(data) {
            let totalTasks = 0;

            const classes = data.d.ResultTasksStudent;
            for (let i = 0; i < classes.length; i++) {
                totalTasks += classes[i].Tasks.length;
            }

            return totalTasks;
        }
    </script>





    <!-- Timetable -->
    <script>
        function timeToMinutes(time) {
            const [hours, minutes] = time.split(':').map(Number);
            return hours * 60 + minutes;
        }



        function addTimetable(data, weekend, today) {

            let currentUnixTimestamp = Math.floor(Date.now() / 1000);

            let dayInCycle = data.d.Info;
            const dataContainer = document.getElementById('timetable');
            const timetableDayText = document.getElementById('timetableDay');
            timetableDayText.textContent = weekend ? 'Weekend' : data.d.Info;

            const periods = data.d.Periods;
            if (weekend && periods.length == 0) {
                const timetableDayText = document.getElementById('timetableDay');
                timetableDayText.textContent = 'Holiday'
                const classDiv = document.createElement('div');
                classDiv.classList.add('small-box', 'rounded', 'p-3', 'mb-2');

                // Create color dot span
                const colorDotSpan = document.createElement('span');
                colorDotSpan.classList.add('color-dot', 'bg-primary', 'me-2');
                classDiv.appendChild(colorDotSpan);

                // Create class name span
                const classNameSpan = document.createElement('span');
                classNameSpan.classList.add('class-name');
                classNameSpan.textContent = "Weekend";
                classDiv.appendChild(classNameSpan);

                // Create teacher div
                const teacherDiv = document.createElement('div');
                teacherDiv.classList.add('teacher-name');
                teacherDiv.textContent = `Enjoy your holiday!`;
                classDiv.appendChild(teacherDiv);

                dataContainer.appendChild(classDiv);
            } else if (weekend) {
                const classDiv = document.createElement('div');
                classDiv.classList.add('small-box', 'rounded', 'p-3', 'mb-2');

                // Create color dot span
                const colorDotSpan = document.createElement('span');
                colorDotSpan.classList.add('color-dot', 'bg-success', 'me-2');
                classDiv.appendChild(colorDotSpan);

                // Create class name span
                const classNameSpan = document.createElement('span');
                classNameSpan.classList.add('class-name');
                classNameSpan.textContent = "Weekend";
                classDiv.appendChild(classNameSpan);

                // Create teacher div
                const teacherDiv = document.createElement('div');
                teacherDiv.classList.add('teacher-name');
                teacherDiv.textContent = `Enjoy your weekend! Here are your classes for Monday.`;
                classDiv.appendChild(teacherDiv);

                dataContainer.appendChild(classDiv);
            } else if (periods.length == 0) {
                const timetableDayText = document.getElementById('timetableDay');
                timetableDayText.textContent = 'Holiday'
                const classDiv = document.createElement('div');
                classDiv.classList.add('small-box', 'rounded', 'p-3', 'mb-2');

                // Create color dot span
                const colorDotSpan = document.createElement('span');
                colorDotSpan.classList.add('color-dot', 'bg-primary', 'me-2');
                classDiv.appendChild(colorDotSpan);

                // Create class name span
                const classNameSpan = document.createElement('span');
                classNameSpan.classList.add('class-name');
                classNameSpan.textContent = "No Classes";
                classDiv.appendChild(classNameSpan);

                // Create teacher div
                const teacherDiv = document.createElement('div');
                teacherDiv.classList.add('teacher-name');
                teacherDiv.textContent = `Enjoy your holiday!`;
                classDiv.appendChild(teacherDiv);

                dataContainer.appendChild(classDiv);
            }

            let lastEndTime = null;
            for (const period of periods) {
                if (period.IsTeachingPeriod) {
                    if (lastEndTime !== null) {
                        const startTimeNextPeriod = period.StartTime;
                        const timeGap = timeToMinutes(startTimeNextPeriod) - timeToMinutes(lastEndTime);

                        if (timeGap === 20 || timeGap === 40) {

                            const divider = document.createElement('div');
                            divider.classList.add('gap-divider', 'mb-2');
                            const lunchText = document.createElement('span');
                            lunchText.classList.add('lunch-text');
                            lunchText.textContent = timeGap === 20 ? 'Recess' : 'Lunch';
                            lunchText.style.marginRight = '5px';
                            divider.style.display = 'flex';
                            divider.style.alignItems = 'center';

                            const line = document.createElement('div');
                            line.classList.add('break-line');
                            line.style.flexGrow = '1';
                            line.style.height = '2px';
                            divider.appendChild(lunchText);
                            divider.appendChild(line);
                            dataContainer.appendChild(divider);

                        }
                    }
                    lastEndTime = period.EndTime;

                    settingValue = localStorage.getItem('sessionSetting');
                    console.log(settingValue)

                    if (settingValue == 'true') {
                        const sessionDiv = document.createElement('div');

                        const sessionSpan = document.createElement('span');
                        sessionSpan.classList.add('session-name');
                        sessionSpan.textContent = period.Description;

                        sessionSpan.setAttribute('data-bs-toggle', 'tooltip');
                        sessionSpan.setAttribute('data-bs-html', 'true');
                        sessionSpan.setAttribute('title', period.Description);


                        sessionDiv.appendChild(sessionSpan);
                        new bootstrap.Tooltip(sessionSpan);
                        dataContainer.appendChild(sessionDiv);
                    }

                    const classDiv = document.createElement('div');

                    const colorDotSpan = document.createElement('span');
                    // Get Class Progress 
                    if (!weekend) {

                        // Get Class Progress
                        let nowT = new Date();

                        let startParts = period['StartTime'].split(":");
                        let startTime = new Date();
                        startTime.setHours(parseInt(startParts[0]), parseInt(startParts[1]), 0, 0);

                        let endParts = period['EndTime'].split(":");
                        let endTime = new Date();
                        endTime.setHours(parseInt(endParts[0]), parseInt(endParts[1]), 0, 0);
                        if (dayInCycle == currentDayInCycle) {
                            if (nowT >= startTime && nowT < endTime) {
                                classDiv.classList.add('small-box', 'rounded', 'p-3', 'mb-2', 'border-timetable');
                            } else {
                                classDiv.classList.add('small-box', 'rounded', 'p-3', 'mb-2');
                            }


                            if (nowT < startTime) {
                                colorDotSpan.classList.add('color-dot', 'bg-primary', 'me-2');
                            } else if (nowT >= startTime && nowT < endTime) {
                                colorDotSpan.classList.add('color-dot', 'bg-warning', 'me-2');
                            } else {
                                colorDotSpan.classList.add('color-dot', 'bg-secondary', 'me-2');
                            }
                        }
                        else {
                            classDiv.classList.add('small-box', 'rounded', 'p-3', 'mb-2');
                            colorDotSpan.classList.add('color-dot', 'bg-primary', 'me-2');
                        }


                    } else {
                        classDiv.classList.add('small-box', 'rounded', 'p-3', 'mb-2');
                        colorDotSpan.classList.add('color-dot', 'bg-primary', 'me-2');
                    }


                    classDiv.appendChild(colorDotSpan);

                    // Create class name span
                    const classNameSpan = document.createElement('span');
                    classNameSpan.classList.add('class-name');
                    classNameSpan.textContent = period.Classes[0].TimeTableClass;

                    classNameSpan.setAttribute('data-bs-toggle', 'tooltip');
                    classNameSpan.setAttribute('data-bs-html', 'true');
                    classNameSpan.setAttribute('title', period.Classes[0].Description);


                    classDiv.appendChild(classNameSpan);
                    new bootstrap.Tooltip(classNameSpan);


                    // Create time span
                    const timeSpan = document.createElement('span');
                    timeSpan.classList.add('time');

                    timeSpan.textContent = `${convertToAMPM(period.StartTime)} - ${convertToAMPM(period.EndTime)}`;
                    classDiv.appendChild(timeSpan);

                    // Create teacher div
                    const teacherDiv = document.createElement('div');
                    teacherDiv.classList.add('teacher-name');

                    let teacherName = period.Classes[0].TeacherName;
                    let roomChange = period.Classes[0].HasRoomChange;
                    let roomInfo
                    roomInfo = filterTimetable(period.Classes[0].Room);

                    // Check if the there is a room change
                    if (roomChange == 'true') {
                        if (teacherName.includes("CRT")) {
                            // If it does, set the text content and change the color to red
                            teacherDiv.innerHTML = `<span style="color: red;">${roomInfo}</span> | <span style="color: red;">${teacherName}</span>`;
                        } else {
                            // Otherwise, set the text content without any styling
                            teacherDiv.textContent = `<span style="color: red;">${roomInfo}</span> | ${teacherName}`;
                        }
                    } else {
                        if (teacherName.includes("CRT")) {
                            // If it does, set the text content and change the color to red
                            teacherDiv.innerHTML = `${roomInfo} | <span style="color: red;">${teacherName}</span>`;
                        } else {
                            // Otherwise, set the text content without any styling
                            teacherDiv.textContent = `${roomInfo} | ${teacherName}`;
                        }
                    }
                    // Append the created classDiv to the body or any other parent element
                    classDiv.appendChild(teacherDiv);
                    dataContainer.appendChild(classDiv);
                } else if (period.IsTeachingPeriod === false &&
                    period.Description !== "Recess Duty" &&
                    period.Description !== "Lunch Duty 1" &&
                    period.Description !== "Lunch Duty 2") {
                    if (lastEndTime !== null) {
                        const startTimeNextPeriod = period.StartTime;
                        const timeGap = timeToMinutes(startTimeNextPeriod) - timeToMinutes(lastEndTime);
                        //Create Reccess/Lunch Divider if needed.
                        if (timeGap === 20 || timeGap === 40) {
                            // Create a divider
                            const divider = document.createElement('div');
                            divider.classList.add('gap-divider', 'mb-2');
                            const lunchText = document.createElement('span');
                            lunchText.classList.add('lunch-text'); // Add your CSS class for styling the text here
                            lunchText.textContent = timeGap === 20 ? 'Recess' : 'Lunch';
                            lunchText.style.marginRight = '5px';
                            divider.style.display = 'flex';
                            divider.style.alignItems = 'center';
                            // Create a div for the horizontal line
                            const line = document.createElement('div');
                            line.classList.add('break-line'); // Add your CSS class for styling the line here
                            line.style.flexGrow = '1'; // Allow the line to grow and fill available space
                            line.style.height = '2px'; // Set the height of the line
                            divider.appendChild(lunchText);
                            divider.appendChild(line);
                            dataContainer.appendChild(divider);
                        }
                        // Sets last end time for recess and lunch calculator
                        lastEndTime = period.EndTime;

                        // Create Box for Timetable
                        const classDiv = document.createElement('div');
                        classDiv.classList.add('small-box', 'rounded', 'p-3', 'mb-2', 'specialbox');

                        // Create class name span
                        const classNameSpan = document.createElement('span');
                        classNameSpan.classList.add('class-name');
                        classNameSpan.setAttribute('data-bs-toggle', 'tooltip');
                        classNameSpan.setAttribute('data-bs-html', 'true');
                        classNameSpan.setAttribute('title', period.Description);
                        classNameSpan.textContent = period.Description;

                        // Create time span
                        const timeSpan = document.createElement('span');
                        timeSpan.classList.add('time');
                        timeSpan.textContent = `${convertToAMPM(period.StartTime)} - ${convertToAMPM(period.EndTime)}`;

                        // Append elements
                        classDiv.appendChild(classNameSpan)
                        classDiv.appendChild(timeSpan);
                        dataContainer.appendChild(classDiv);
                    }
                }

            }


            const divElement = document.getElementById('timetableLoading');
            divElement.style.display = 'none';
            document.getElementById('prevDay').disabled = false
            document.getElementById('nextDay').disabled = false
        }
    </script>
    <script>
        currentDate = new Date();

        document.getElementById('prevDay').addEventListener('click', function () {
            const timetableDayText = document.getElementById('timetableDay');
            timetableDayText.textContent = "LOADING"

            document.getElementById('prevDay').disabled = true
            document.getElementById('nextDay').disabled = true
            currentDate.setDate(currentDate.getDate() - 1);
            fetchTimetable(currentDate, false, false);
        });

        document.getElementById('nextDay').addEventListener('click', function () {
            const timetableDayText = document.getElementById('timetableDay');
            timetableDayText.textContent = "LOADING"

            document.getElementById('prevDay').disabled = true
            document.getElementById('nextDay').disabled = true
            currentDate.setDate(currentDate.getDate() + 1);
            fetchTimetable(currentDate, false, true);
        });

        function fetchTimetable(date, today) {

            document.getElementById('timetable').innerHTML = '';

            const classDiv = document.createElement('div');
            classDiv.classList.add('small-box', 'rounded', 'p-3', 'mb-2');
            classDiv.id = "timetableLoading"

            const colorDotSpan = document.createElement('span');
            colorDotSpan.classList.add('color-dot', 'bg-primary', 'me-2');
            classDiv.appendChild(colorDotSpan);

            // Create class name span
            const classNameSpan = document.createElement('span');
            classNameSpan.classList.add('class-name');
            classNameSpan.textContent = "Loading";

            classDiv.appendChild(classNameSpan);


            const teacherDiv = document.createElement('div');
            teacherDiv.classList.add('teacher-name');
            teacherDiv.textContent = "Your classes are loading...";

            classDiv.appendChild(teacherDiv);

            const dataContainer = document.getElementById('timetable');
            dataContainer.appendChild(classDiv);

            let dateString = date.toISOString();
            let dayOfWeekNumber = currentDate.getDay();
            let currentDay = daysOfWeek[dayOfWeekNumber]
            let currentISOString = currentDate.toISOString();

            if (currentDay == "Saturday" || currentDay == "Sunday") {


                let data = {
                    date: getNextMonday(currentISOString)
                };

                fetch(`/api/getTimetable?date=${getNextMonday(currentISOString)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                    .then(response => response.json())
                    .then(data => {
                        addTimetable(data, true, today)
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            } else {

                let data = {
                    date: currentISOString
                };

                fetch(`/api/getTimetable?date=${currentISOString}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                    .then(response => response.json())
                    .then(data => {
                        addTimetable(data, false, today)

                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            }

        }

        // currentDate.setDate(currentDate.getDate() + 1);
        fetchTimetable(currentDate, true, false);

    </script>







    <script>
        let today = new Date();
        let yyyy = today.getFullYear();
        let mm = String(today.getMonth() + 1).padStart(2, '0');  // January is 0!
        let dd = String(today.getDate()).padStart(2, '0');

        let formattedDate = `${yyyy} ${mm} ${dd}`;

        function isNewMessage(unixTimestamp) {
            newUnix = parseInt(unixTimestamp.replace(/\D/g, ''), 10);

            dateUnix = new Date(newUnix);

            yyyyUnix = dateUnix.getFullYear();
            mmUnix = String(dateUnix.getMonth() + 1).padStart(2, '0');  // January is 0!
            ddUnix = String(dateUnix.getDate()).padStart(2, '0');

            formattedDateUnix = `${yyyyUnix} ${mmUnix} ${ddUnix}`;

            if (formattedDateUnix == formattedDate) {
                return true
            } else {
                return false
            }
        }
    </script>
    <!-- Daily Messages -->
    <script>

        let data = {
            date: currentISOString
        };

        fetch(`/api/getDailyMessages`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(data => {
                const dataContainer = document.getElementById('dailyMessages');

                const periods = data.d.SchoolMessages;

                let musicLessons

                fetch('/api/getMusic', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.text())
                    .then(theme => {
                        const musicLessons = theme
                        for (const message of periods) {
                            if (unixTimestampInSeconds < extractNumberFromString(message.StartDateTime)) {
                                if (musicLessons && musicLessons == 'no') {
                                    messageTitle = message.MessageTitle
                                    if (messageTitle.toLowerCase().includes('lesson')) {
                                        continue
                                    }
                                }


                                totalDailyMessages += 1


                                // Create the <h6> element
                                const classDiv = document.createElement('div');
                                classDiv.classList.add('small-box', 'rounded', 'p-3', 'mb-2');

                                if (isNewMessage(message['StartDateTime'])) {
                                    // Create color dot span
                                    const colorDotSpan = document.createElement('span');
                                    colorDotSpan.classList.add('color-dot', 'bg-danger', 'me-2');
                                    classDiv.appendChild(colorDotSpan);
                                }

                                const classNameSpan = document.createElement('span');
                                classNameSpan.classList.add('class-name');
                                classNameSpan.textContent = message.MessageTitle;
                                classDiv.appendChild(classNameSpan);

                                const teacherDiv = document.createElement('div');
                                teacherDiv.classList.add('teacher-name');
                                teacherDiv.innerHTML = removeColorStyles(message.MessageContent);
                                classDiv.appendChild(teacherDiv);

                                const timeSpan = document.createElement('span');
                                timeSpan.classList.add('time');
                                timeSpan.textContent = `By: ${message.SubmittedByUserName}`;
                                classDiv.appendChild(timeSpan);

                                dataContainer.appendChild(classDiv);

                            }
                        }
                        const dailyMessageCountText = document.getElementById('totalDailyMessages');
                        dailyMessageCountText.textContent = totalDailyMessages + " Messages"

                        const divElement = document.getElementById('dailyMessagesLoading');
                        divElement.style.display = 'none';
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });

            })
            .catch(error => {
                console.error('Error:', error);
            });
    </script>


    <!-- Weather -->
    <script>
        fetch(`/api/getWeather`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
        })
            .then(response => response.json())
            .then(data => {

                const weatherIcon = document.getElementById('weatherIcon');
                weatherIcon.src = data.currentIcon;

                const currentWeather = document.getElementById('currentWeather');
                currentWeather.textContent = data.currentTemperature.toFixed(1) + '¬∞';

                const upcomingWeather = document.getElementById('minMax');
                upcomingWeather.textContent = `‚¨áÔ∏è ${data.mininumTemperature.toFixed(1)}¬∞ | ‚¨ÜÔ∏è ${data.maximumTemperature.toFixed(1)}¬∞ | ü§î ${data.currentFeelsLikeTemperature.toFixed(1)}¬∞`;

                const weatherInformation = document.getElementById('weatherInformation');
                weatherInformation.textContent = `${data.currentDescription}`;

                const weatherCampus = document.getElementById('weatherCampus');
                weatherCampus.textContent = data.campus;
            })
            .catch(error => {
                console.error('Error:', error);
            });
    </script>


    <!-- Classes (Due, Results, Overdue) -->
    <script>
        fetch(`/api/getClasses`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
        })
            .then(response => response.json())
            .then(data => {


                // Due
                const dueTasks = document.getElementById('dueTasks');
                const dueContainer = document.getElementById('dueTasksExpand');
                dueTasks.textContent = data.d.DueTasksStudent.length + ' Due'
                for (const task of data.d.DueTasksStudent) {
                    var spanElement = document.createElement('span');
                    spanElement.className = 'ms-2';

                    var boldElement = document.createElement('b');
                    boldElement.textContent = task['TaskTitle'];
                    spanElement.appendChild(boldElement);

                    spanElement.append(` (${task['ClassCode']})`);

                    var brElement = document.createElement('br');
                    spanElement.append(brElement);

                    dueContainer.appendChild(spanElement);
                }

                // Overdue
                const overdueTasks = document.getElementById('overdueTasks');
                const overdueContainer = document.getElementById('overdueTasksExpand');
                overdueTasks.textContent = data.d.OverDueTasksStudent.length + ' Overdue'
                for (const task of data.d.OverDueTasksStudent) {
                    var spanElement = document.createElement('span');
                    spanElement.className = 'ms-2';

                    var boldElement = document.createElement('b');
                    boldElement.textContent = task['TaskTitle'];
                    spanElement.appendChild(boldElement);

                    spanElement.append(` (${task['ClassCode']})`);

                    var brElement = document.createElement('br');
                    spanElement.append(brElement);

                    overdueContainer.appendChild(spanElement);
                }

                const resultTasks = document.getElementById('resultTasks');
                const resultContainer = document.getElementById('resultTasksExpand');
                resultTasks.textContent = countTotalTasks(data) + ' Results'

                for (const classF of data.d.ResultTasksStudent) {
                    for (const task of classF.Tasks) {
                        var spanElement = document.createElement('span');
                        spanElement.className = 'ms-2';

                        var boldElement = document.createElement('b');
                        boldElement.textContent = task['Title'];
                        spanElement.appendChild(boldElement);

                        spanElement.append(` (${task['FinalResult']})`);

                        var brElement = document.createElement('br');
                        spanElement.append(brElement);

                        resultContainer.appendChild(spanElement);
                    }

                }

            })
            .catch(error => {
                console.error('Error:', error);
            });
    </script>


    <!-- Today -->
    <script>
        fetch(`/api/getToday`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
        })
            .then(response => response.json())
            .then(data => {
                const dataContainer = document.getElementById('todayActivities');

                const events = data.d.Events;

                if (events.length == 0) {
                    const classDiv = document.createElement('div');
                    classDiv.classList.add('small-box', 'rounded', 'p-3', 'mb-2');


                    // Create class name span
                    const classNameSpan = document.createElement('span');
                    classNameSpan.classList.add('class-name');
                    classNameSpan.textContent = 'Nothing to see here.';
                    classDiv.appendChild(classNameSpan);

                    const teacherDiv = document.createElement('div');
                    teacherDiv.classList.add('teacher-name');
                    teacherDiv.textContent = `You have nothing on today.`;
                    classDiv.appendChild(teacherDiv);


                    // Append the created classDiv to the body or any other parent element
                    dataContainer.appendChild(classDiv);


                }


                for (const event of events) {

                    const classDiv = document.createElement('div');
                    classDiv.classList.add('small-box', 'rounded', 'p-3', 'mb-2');


                    // Create class name span
                    const classNameSpan = document.createElement('span');
                    classNameSpan.classList.add('class-name');
                    classNameSpan.textContent = event.EventTitle;
                    classDiv.appendChild(classNameSpan);


                    // Append the created classDiv to the body or any other parent element
                    dataContainer.appendChild(classDiv);

                }

                const divElement = document.getElementById('timetableLoading');
                divElement.style.display = 'none';


            })
            .catch(error => {
                console.error('Error:', error);
            });
    </script>
    
    <!-- Tooltips -->
    <script>
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    </script>

    <script>
        // Function to calculate the day within a two-week cycle
        function getDayInCycle(currentDate) {
            const cycle = [
                'Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Weekend', 'Weekend',
                'Day 6', 'Day 7', 'Day 8', 'Day 9', 'Day 10', 'Weekend', 'Weekend'
            ];

            const referenceDate = moment('2023-10-16').startOf('day'); // Set the reference date at the start of the day
            const localCurrentDate = moment(currentDate);
            console.log(referenceDate, localCurrentDate)

            const timeDiff = moment.duration(localCurrentDate.diff(referenceDate));
            const daysInCycle = Math.floor(timeDiff.asDays()) % cycle.length;
            return cycle[daysInCycle];
        }

        // Example usage:
        const todays = moment(); // Use moment to create the current date
        currentDayInCycle = getDayInCycle(todays);
        currentDayInCycle = `Timetable ${currentDayInCycle}`;
        console.log(currentDayInCycle);
    </script>




    <!-- Themes -->
    {% include "partials/themes.html" %}

</body>

</html>