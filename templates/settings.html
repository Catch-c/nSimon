<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSimon | Settings</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='favicon/apple-touch-icon.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon/favicon-16x16.png') }}">
    <link rel="manifest" href="{{ url_for('static', filename='favicon/site.webmanifest') }}">
    <link rel="mask-icon" href="{{ url_for('static', filename='favicon/safari-pinned-tab.svg') }}" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#3a3a3a">

</head>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');
    @import url("https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css");
</style>

<body>

    <div class="position-fixed bottom-0 end-0 p-3">
        <div class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive"
            aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    Settings updated!
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
        </div>
    </div>

    {% include "partials/navbar.html" %}




    <div class="mainBody container-fluid h-100">


        <div class="row h-100 ps-2 pt-3">
            <!-- Timetable -->
            <div class="col-md-3 col-12p-3 order-1 order-md-1">
                <h4 class="settingsPageSubtitle" style="font-weight: 600;">Settings
                </h4>

                    <div class="big-box rounded p-3 mb-2" id="timetableLoading">
                        <button class="toggleDarkModeButton" onclick="toggleTheme()">Toggle Theme</span><br>
                        <h6 id="currentTheme">Current Theme</h1>
                    </div>
                    <div class="big-box rounded p-3 mb-2" id="timetableLoading">
                        <span class="class-name">Selected Campus</span><br>
                        <select class="settingsSelect" id="campusSelection" name="campusSelection">
                            <option value="Berwick" selected>BERWICK</option>
                            <option value="Officer">OFFICER</option>
                            <option value="Beaconsfield">BEACONSFIELD</option>
                        </select>
                    </div>

                    <div class="big-box rounded p-3 mb-2" id="timetableLoading">
                        <span class="class-name">Show Session Numbers on Timetable</span><br>
                        <select class="settingsSelect" id="sessionSelection" name="sessionSelection">
                            <option value="Hide">HIDE</option>
                            <option value="Show" selected>SHOW</option>
                        </select>
                    </div>       

                    <div class="big-box rounded p-3 mb-2" id="timetableLoading">
                        <span class="class-name">Show Music Lessons on Daily Messages</span><br>
                        <select class="settingsSelect" id="musicSelection" name="musicSelection">
                            <option value="Hide">HIDE</option>
                            <option value="Show" selected>SHOW</option>
                        </select>
                    </div>                


            </div>
        </div>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>

    
    <!-- Get Cookie/Campus -->
    <script>
        function getCookie(cookieName) {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(cookieName + '=')) {
                    return cookie.substring(cookieName.length + 1);
                }
            }
            return null;
        }

        const authCookie = getCookie('adAuthCookie');
        const campus = getCookie('campus');

        if (authCookie == null) {
            window.location.href = '/logout';
        }

        if (campus == null) {
            window.location.href = '/logout';
        }

    </script>

    <!-- Variables -->
    <script>


    


        // Function to set a cookie
        function setCookie(name, value, days) {
            console.log(name, value)
            var expires = "";
            if (days) {
                var date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "") + expires + "; path=/";
        }

    </script>


    <!-- Time/Data Updated -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            function updateDateAndTime() {
                const today = new Date();

                // Update Date
                const day = String(today.getDate()).padStart(2, '0');
                const month = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-based
                const year = today.getFullYear();
                const formattedDate = `${day}/${month}/${year}`;
                document.getElementById("currentDate").textContent = formattedDate;

                // Update Time
                let hours = today.getHours();
                const minutes = String(today.getMinutes()).padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';

                // Convert 24-hour time to 12-hour time format
                hours = hours % 12;
                // If hour is 0 (which would be 12 in 24-hour time), set it to 12
                hours = hours ? hours : 12;
                const formattedTime = `${String(hours).padStart(2, '0')}:${minutes} ${ampm}`;
                document.getElementById("currentTime").textContent = formattedTime;
            }

            // Call the function to initialize the display
            updateDateAndTime();

            // Set an interval to update the time every minute
            setInterval(updateDateAndTime, 60 * 1000); // 60 * 1000ms = 1 minute
        });
    </script>


    <!-- Functions -->
    <script>

        function getNextMonday(currentISODate) {
            const currentDate = new Date(currentISODate);
            const dayOfWeek = currentDate.getDay();
            const daysUntilMonday = (8 - dayOfWeek) % 7; // Calculate how many days until Monday
            const nextMonday = new Date(currentDate);
            nextMonday.setDate(currentDate.getDate() + daysUntilMonday);
            return nextMonday.toISOString();
        }


        function convertToAMPM(timeString) {
            // Split the input time string into hours and minutes
            const [hours, minutes] = timeString.split(':');

            // Convert hours to a number
            const hour = parseInt(hours, 10);

            // Determine whether it's AM or PM based on the hour
            const period = hour >= 12 ? 'PM' : 'AM';

            // Convert hours to 12-hour format
            const formattedHour = hour % 12 === 0 ? 12 : hour % 12;

            // Create the formatted time string
            const formattedTime = `${formattedHour}:${minutes}${period}`;

            return formattedTime;
        }

        function removeFirstFourCharacters(inputString) {
            if (inputString.length >= 4) {
                return inputString.substring(4);
            } else {
                // Handle cases where the input string is less than 4 characters
                return "Input string is too short";
            }
        }

        function removeFirstThreeCharacters(inputString) {
            if (inputString.length >= 3) {
                return inputString.substring(3);
            } else {
                // Handle cases where the input string is less than 4 characters
                return "Input string is too short";
            }
        }

        function extractNumberFromString(text) {
            // Use a regular expression to match the number inside the text
            const regex = /(\d+)/;

            // Use the match method to find the first occurrence of the number
            const match = text.match(regex);

            // Check if a match was found
            if (match) {
                // Convert the matched string to a number
                const number = parseInt(match[0]);

                return number;
            }

            // If no match was found, return null or an appropriate value
            return null;
        }

        function countTotalTasks(data) {
            let totalTasks = 0;

            const classes = data.d.ResultTasksStudent;
            for (let i = 0; i < classes.length; i++) {
                totalTasks += classes[i].Tasks.length;
            }

            return totalTasks;
        }
    </script>

    <!-- Initialize Music-->
    <script>
        fetch('/api/getMusic', {
               method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.text())
            .then(theme => {
                switch (theme) {
                    case 'yes':
                        document.getElementById("musicSelection").value = 'Show';
                        break;
                    case 'no':
                        document.getElementById("musicSelection").value = 'Hide';
                        break;
                    default:
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    </script>

    <!-- Initialize session Setting-->
    <script>
        fetch('/api/getSessionSetting', {
               method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.text())
            .then(theme => {
                switch (theme) {
                    case 'true':
                        document.getElementById("sessionSelection").value = 'Show';
                        break;
                    case 'false':
                        document.getElementById("sessionSelection").value = 'Hide';
                        break;
                    default:
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    </script>

    <!-- Change Music-->
    <script>

        document.getElementById("musicSelection").addEventListener("change", function (event) {
            event.preventDefault();

            var value = document.getElementById("musicSelection").value;
            
            if (value == "Show") {
                let data = { music: 'yes' };
                fetch("/api/setMusic", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => {
                if (response.ok) {
                    console.log(`music set to show`);
                } else {
                    console.error('Failed to set music');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
            } else {
                let data = { music: 'no' };
                fetch("/api/setMusic", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => {
                if (response.ok) {
                    console.log(`music set to hide`);
                } else {
                    console.error('Failed to set music');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
            }

            var toastEl = new bootstrap.Toast(document.querySelector(".toast"));
            toastEl.show();
        });

    </script>

    <!-- Change Session Setting-->
    <script>

        document.getElementById("sessionSelection").addEventListener("change", function (event) {
            event.preventDefault();

            var value = document.getElementById("sessionSelection").value;
            
            if (value == "Show") {
                let data = { session: 'true' };
                fetch("/api/setSessionSetting", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => {
                if (response.ok) {
                    console.log(`Session set to show`);
                } else {
                    console.error('Failed to set Session');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
            } else {
                let data = { session: 'false' };
                fetch("/api/setSessionSetting", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => {
                if (response.ok) {
                    console.log(`Session set to hide`);
                } else {
                    console.error('Failed to set Session');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
            }

            var toastEl = new bootstrap.Toast(document.querySelector(".toast"));
            toastEl.show();
        });

    </script>

    <!-- Campus Selection -->
    <script>
        window.onload = function () {
            // Get the value of the cookie named 'myCookie'
            var cookieValue = getCookie("campus");

            // If the cookie has a value, set that value as the selected option in the dropdown
            if (cookieValue) {
                document.getElementById("campusSelection").value = cookieValue;
            }
        }
    </script>
    <script>
        document.getElementById("campusSelection").addEventListener("change", function (event) {
            event.preventDefault();
            var value = document.getElementById("campusSelection").value;
            setCookie("campus", value, 30);
            var toastEl = new bootstrap.Toast(document.querySelector(".toast"));
            toastEl.show();
        });
    </script>

    <!-- Themes -->
    <script>
        let availableThemes = ['light', 'dark', 'blue', 'tiktok'];
        let currentTheme = 0;
        const cachedTheme = localStorage.getItem('theme');
            if (cachedTheme && availableThemes.includes(cachedTheme)) {
            document.documentElement.setAttribute('data-theme', cachedTheme);
        }

        function loadTheme() {
            fetch('/api/getTheme', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.text())
            .then(theme => {
                switch (theme) {
                    case 'dark':
                        setTheme('dark');
                        break;
                    case 'light':
                        setTheme('light');
                        break;
                    case 'tiktok':
                        setTheme('tiktok');
                        break;
                    case 'blue':
                        setTheme('blue');
                        break;
                    default:
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            // Update the current theme index
            currentTheme = availableThemes.indexOf(theme);
            updateThemeInServer(theme);
        }

        function updateThemeInServer(theme) {
            const username = getCookie("username");

            if (!username) {
                console.log("Username not found in cookies.");
                return;
            }

            const data = { theme: theme };
            localStorage.setItem('theme', theme);
            fetch("/api/setTheme", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => {
                if (response.ok) {
                    console.log(`Theme set to ${theme}`);
                } else {
                    console.error('Failed to set theme');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        document.addEventListener('keydown', function (event) {
            // Check if the key combination is "Ctrl + D" (or "Command + D" on Mac)
            if (event.ctrlKey && event.altKey && event.key === 'd') {
                toggleTheme(); // Toggle dark mode when the shortcut is triggered
            }
        });

        function toggleTheme() {
            const currentThemeText = document.getElementById('currentTheme');
            currentTheme = (currentTheme + 1) % availableThemes.length;
            const nextTheme = availableThemes[currentTheme];
            setTheme(nextTheme);
            switch (nextTheme) {
                    case 'dark':
                        currentThemeText.textContent = 'Current Theme: Dark Mode'
                        break;
                    case 'light':
                        currentThemeText.textContent = 'Current Theme: Light Mode'
                        break;
                    case 'tiktok':
                        currentThemeText.textContent = 'Current Theme: TikTok Style'
                        break;
                    case 'blue':
                        currentThemeText.textContent = 'Current Theme: Blue Theme'
                        break;
                    default:
                }

        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        loadTheme();
    </script>
    <script>
        function checkNewLoginAndLogOut() {
        // Check if the "username" cookie exists
            const usernameCookie = getCookie("username");
    
            if (!usernameCookie) {
                // Clear all cookies
               window.location.href = "/logout";  // Adjust the URL as needed
        }
    }
    checkNewLoginAndLogOut();
    </script>

    <script>
        const currentThemeText = document.getElementById('currentTheme');

        fetch('/api/getTheme', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.text())
            .then(theme => {
                switch (theme) {
                    case 'dark':
                        currentThemeText.textContent = 'Current Theme: Dark Mode'
                        break;
                    case 'light':
                        currentThemeText.textContent = 'Current Theme: Light Mode'
                        break;
                    case 'tiktok':
                        currentThemeText.textContent = 'Current Theme: TikTok Style'
                        break;
                    case 'blue':
                        currentThemeText.textContent = 'Current Theme: Blue Theme'
                        break;
                    default:
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    </script>




</body>

</html>